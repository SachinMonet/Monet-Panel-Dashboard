<div class="dashboard-root">
  <div class="dashboard-shell">

    <!-- Header -->
    <header class="header">
      <div class="header__left">
        <div class="header__logo"><span>PM</span></div>
        <h1 class="header__title">Campaign Dashboard</h1>
      </div>
      <div class="header__right">
        <button class="btn btn--primary" (click)="createNewCampaign()">+ New Campaign</button>
        <button class="icon-btn" title="Settings" routerLink="/providers">
          <lucide-icon name="settings" class="icon"></lucide-icon>
        </button>
        <div class="header__profile">
          <button class="header__avatar" (click)="toggleProfileMenu()" [class.header__avatar--active]="showProfileMenu">
            <span>JD</span>
          </button>
          @if (showProfileMenu) {
          <div class="profile-menu" [@slideDown]>
            <div class="profile-menu__header">
              <div class="profile-menu__user">
                <div class="profile-menu__avatar-lg">JD</div>
                <div>
                  <p class="profile-menu__name">John Doe</p>
                  <p class="profile-menu__email">john.doe&#64;company.com</p>
                </div>
              </div>
            </div>
            <div class="profile-menu__divider"></div>
            <button class="profile-menu__item" (click)="closeProfileMenu()" routerLink="/profile">
              <lucide-icon name="user" class="profile-menu__icon"></lucide-icon><span>My Profile</span>
            </button>
            <!-- <button class="profile-menu__item" (click)="closeProfileMenu()" routerLink="/settings">
              <lucide-icon name="settings" class="profile-menu__icon"></lucide-icon><span>Settings</span>
            </button> -->
            <button class="profile-menu__item" (click)="closeProfileMenu()" routerLink="/help-support">
              <lucide-icon name="help-circle" class="profile-menu__icon"></lucide-icon><span>Help & Support</span>
            </button>
            <div class="profile-menu__divider"></div>
            <button class="profile-menu__item profile-menu__item--danger" (click)="logout()">
              <lucide-icon name="log-out" class="profile-menu__icon"></lucide-icon><span>Logout</span>
            </button>
          </div>
          }
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs-header">
      <div class="tabs">
        @for (tab of tabs; track tab) {
        <button class="tabs__item" [class.tabs__item--active]="activeTab === tab" (click)="setTab(tab)">
          {{ tab }}
        </button>
        }
      </div>
    </div>

    <main class="content">

      <!-- Attention Required – Slow Panels -->
      @if (hasAlertPanels()) {
      <section class="alert-card">
        <h2 class="alert-card__title">Attention Required – Slow Panels</h2>
        <div class="alert-list">
          @for (alert of getAlertPanels(); track alert.panelId) {
          <div class="alert-row">
            <div class="alert-row__info">
              <div class="alert-row__name">{{ alert.campaignName }} → {{ alert.panelName }}</div>
              <div class="alert-row__meta">
                <span>{{ alert.completes }} completes</span>
                @if (alert.badge) {
                <span class="alert-row__badge">{{ alert.badge }}</span>
                }
                <span class="alert-row__badge alert-row__badge--slow">Slow</span>
              </div>
            </div>
            <div class="alert-row__actions">
              <button class="btn btn--ghost" (click)="boostPanel(alert)">
                <lucide-icon name="zap" class="icon icon--left"></lucide-icon><span>Boost Panel</span>
              </button>
              <button class="btn btn--ghost" (click)="reconfigurePanel(alert)">
                <lucide-icon name="settings" class="icon icon--left"></lucide-icon><span>Reconfigure Panel</span>
              </button>
              <button class="btn btn--ghost" (click)="dismissAlert(alert)">
                <lucide-icon name="x" class="icon icon--left"></lucide-icon><span>Dismiss</span>
              </button>
            </div>
          </div>
          }
        </div>
      </section>
      }

      <!-- Table -->
      <section class="table-card">
        <table class="table">
          <thead>
            <tr>
              <th style="width:40px"></th>
              <th>Campaign / Panel</th>
              <th>Progress</th>
              <th>Velocity</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (row of getFilteredCampaigns(); track row.id) {

            <!-- Campaign Row -->
            <tr class="campaign-row" (click)="toggleExpand(row.id)">
              <td class="expand-cell">
                <button class="expand-btn" [class.expanded]="isExpanded(row.id)">
                  <lucide-icon name="chevron-down" class="icon icon--small"></lucide-icon>
                </button>
              </td>
              <td>
                <div class="campaign-name">{{ row.name }}</div>
                <div class="campaign-sub">{{ row.panels.length }} panels</div>
              </td>
              <td>
                <div class="progress">
                  <div class="progress__track">
                    <div class="progress__indicator"
                      [style.transform]="'translateX(' + (row.progress - 100) + '%)'">
                    </div>
                  </div>
                  <span class="progress__value">{{ row.completes }}/{{ row.target }}</span>
                </div>
              </td>
              <td><span class="dash-text">—</span></td>
              <td>
                <span class="status-badge status-badge--live">{{ row.status }}</span>
              </td>
              <td>
                <div class="row-actions">
                  <button class="icon-btn" title="Add Panel" (click)="addPanel(row, $event)">
                    <lucide-icon name="plus" class="icon icon--small" routerLink="/create-campaigns" ></lucide-icon>
                  </button>
                  <button class="icon-btn" title="Settings" (click)="editCampaign(row, $event)" routerLink="/providers">
                    <lucide-icon name="settings" class="icon icon--small"></lucide-icon>
                  </button>
                  <button class="icon-btn" title="Launch" (click)="launchCampaign(row, $event)" >
                    <lucide-icon name="play" class="icon icon--small"></lucide-icon>
                  </button>
                  <button class="icon-btn" title="Close" (click)="closeCampaign(row, $event)">
                    <lucide-icon name="x" class="icon icon--small"></lucide-icon>
                  </button>
                </div>
              </td>
            </tr>

            <!-- Panel Sub-Rows -->
            @if (isExpanded(row.id)) {
              @for (panel of row.panels; track panel.id) {
              <tr class="panel-subrow">
                <td></td>
                <td class="panel-name-cell">
                  <span class="panel-arrow">↳</span> {{ panel.name }}
                </td>
                <td>
                  <span class="completes-text">{{ panel.completes }} completes</span>
                </td>
                <td>
                  <span class="chip" [ngClass]="getVelocityClass(panel.velocity)">{{ panel.velocity }}</span>
                </td>
                <td>
                  <span class="status-badge status-badge--active">{{ panel.status }}</span>
                </td>
                <td>
                  <div class="row-actions">
                    <button class="icon-btn" title="Boost" (click)="boostPanelById(panel)">
                      <lucide-icon name="zap" class="icon icon--small"></lucide-icon>
                    </button>
                    <button class="icon-btn" title="Clone" (click)="clonePanel(panel)">
                      <lucide-icon name="copy" class="icon icon--small"></lucide-icon>
                    </button>
                    <button class="icon-btn" title="Pause" (click)="pausePanel(panel)">
                      <lucide-icon name="pause" class="icon icon--small"></lucide-icon>
                    </button>
                    <button class="icon-btn" title="Remove" (click)="removePanel(panel)">
                      <lucide-icon name="x" class="icon icon--small"></lucide-icon>
                    </button>
                  </div>
                </td>
              </tr>
              }
            }

            }
          </tbody>
        </table>
      </section>

    </main>
  </div>
</div>