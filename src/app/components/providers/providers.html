@if (isLoading()) {
<div class="loader-wrapper">
    <div class="loader-container">
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
    </div>
    <p class="loader-text">Loading...</p>
</div>
} @else {
<div class="panel-page">
  <div class="panel-container">

    <header class="panel-header">
      <div class="panel-header__inner">
        <button class="panel-header__back-btn" routerLink="/dashboard">
          <lucide-icon name="arrow-left" class="icon-20"></lucide-icon>
        </button>
        <div class="panel-header__logo"><span>PM</span></div>
        <h1 class="panel-header__title">Panel Provider Management</h1>
      </div>
    </header>

    <main class="panel-main">

      @if (!showWizard()) {
      <div class="panel-main__content">

        <div class="panel-toolbar">
          <button class="btn-primary" type="button" (click)="addPanel()">
            <lucide-icon name="plus"></lucide-icon>
            Add New Panel Provider
          </button>
        </div>

        <div class="panel-table-wrapper">
          <table class="panel-table">
            <thead>
              <tr>
                <th>Provider Name</th>
                <th>Panel ID</th>
                <th>Region</th>
                <th>Status</th>
                <th>API Health</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
            <tbody>
              @for (p of providers(); track p.id; let i = $index) {
              <tr [class.row-alt]="i % 2 === 1">
                <td class="td-name">
                  {{ p.provider_name }}
                </td>

                <td>
                  {{ p.panel_id || '_' }}
                </td>

                <td>
                  {{ p.region }}
                </td>

                <td>
                  <span [class]="statusClass(p.status)">
                    {{ p.status }}
                  </span>
                </td>

                <td>
                  <div class="api-health">
                    <lucide-icon [name]="p.api_health === 'Healthy' ? 'circle-check-big' : 'circle-x'"
                      class="api-health__icon" [class.text-green-600]="p.api_health === 'Healthy'"
                      [class.text-red-600]="p.api_health !== 'Healthy'"></lucide-icon>

                    <span>
                      {{ p.api_health }}
                    </span>
                  </div>
                </td>

                <td class="py-3 px-4">
                  <div class="flex gap-2">
                    <button type="button"
                      class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 border bg-background text-foreground hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3 border-neutral-400">
                      View
                    </button>

                    <button type="button" (click)="editPanel(p.id)"
                      class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 border bg-background text-foreground hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3 border-neutral-400">
                      <lucide-icon name="square-pen" class="w-4 h-4"></lucide-icon>
                    </button>
                     <button type="button"  (click)="openDeleteDialog(p.id)"
                      class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 border bg-background text-foreground hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3 border-neutral-400">
                         <lucide-icon name="trash-2" class="icon-tiny"></lucide-icon>
                    </button>
                   
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      }

      @if (showWizard()) {
      <div class="panel-wizard">
        <div class="panel-wizard__container">

          <div class="wizard-steps">
            @for (item of steps; track item.step; let last = $last) {
            <div class="wizard-steps__item">
              <div class="wizard-steps__circle" [class.wizard-steps__circle--active]="currentStep() === item.step"
                [class.wizard-steps__circle--completed]="currentStep() > item.step">
                {{ item.step }}
              </div>
              <div class="wizard-steps__label">{{ item.label }}</div>
            </div>
            @if (!last) { <div class="wizard-steps__line"></div> }
            }
          </div>

          <div class="wizard-card">
            <h2 class="wizard-card__title">{{ currentStepTitle() }}</h2>

            <form [formGroup]="providerForm" class="wizard-card__fields">
              @switch (currentStep()) {

              @case (1) {
              <div formGroupName="basic" class="step-group">
                <div class="field">
                  <label class="field__label">Provider Name</label>
                  <input formControlName="name" type="text" class="field__input" placeholder="e.g. Lucid" />
                </div>
                <div class="field">
                  <label class="field__label">Panel ID</label>
                  <input formControlName="panelId" type="text" class="field__input" placeholder="e.g. LUC1" />
                </div>
                <div class="field">
                  <label class="field__label">Region</label>
                  <select formControlName="region" class="field__input">
                    <option value="" disabled selected class="text-neutral-400">Select region</option>

                    @for (r of regions(); track r.id) {
                    <option [value]="r.id">{{ r.region_name }}</option>
                    }
                  </select>
                </div>
              </div>
              }

              <!-- @case (2) {
                    <div formGroupName="credentials" class="step-group">
                      <div class="field">
                        <label class="field__label">API Endpoint</label>
                        <input formControlName="endpoint" type="text" class="field__input" placeholder="https://api..." />
                      </div>
                      <div class="field">
                        <label class="field__label">API Key</label>
                        <input formControlName="key" type="text" class="field__input" />
                      </div>
                      <div class="field">
                        <label class="field__label">API Secret</label>
                        <input formControlName="secret" type="password" class="field__input" />
                      </div>
                    </div>
                  }

                  @case (3) {
                    <div formGroupName="params" class="step-group">
                      <div class="field">
                        <label class="field__label">Panel ID Parameter</label>
                        <input formControlName="panelIdParam" type="text" class="field__input" placeholder="pid" />
                      </div>
                      <div class="field">
                        <label class="field__label">Session ID Parameter</label>
                        <input formControlName="sessionIdParam" type="text" class="field__input" placeholder="sid" />
                      </div>
                      <div class="field">
                        <label class="field__label">Custom Parameters</label>
                        <input formControlName="customParams" type="text" class="field__input" placeholder="a,b,c" />
                      </div>
                    </div>
                  } -->

              @case (2) {
              <div formGroupName="redirects" class="step-group">
                <div class="field">
                  <label class="field__label">Success URL</label>
                  <input formControlName="successUrl" type="text" class="field__input"
                    placeholder="https://panel.example.com/success?pid=[PID]&sid=[SID]" />
                </div>
                <div class="field">
                  <label class="field__label">Termination URL</label>
                  <input formControlName="terminateUrl" type="text" class="field__input"
                    placeholder="https://panel.example.com/terminate?pid=[PID]&sid=[SID]" />
                </div>
                <div class="field">
                  <label class="field__label">Overquota URL</label>
                  <input formControlName="overquotaUrl" type="text" class="field__input"
                    placeholder="https://panel.example.com/overquota?pid=[PID]&sid=[SID]" />
                </div>
                <div class="field">
                  <label class="field__label">Quality Fail URL</label>
                  <input formControlName="qualityFailUrl" type="text" class="field__input"
                    placeholder="https://panel.example.com/quality-fail?pid=[PID]&sid=[SID]" />
                </div>
              </div>
              }

              @case (3) {
              <div class="test-card">
                <div class="test-card__info">
                  <div class="test-row">
                    <span class="test-row__label">Provider Name:</span>
                    <span class="test-row__value">{{ providerForm.get('basic.name')?.value || 'Not set' }}</span>
                  </div>
                  <div class="test-row">
                    <span class="test-row__label">Region:</span>
                    <span class="test-row__value">{{ providerForm.get('basic.region')?.value || 'Not set'
                      }}</span>
                  </div>
                  <div class="test-row">
                    <span class="test-row__label">SuccessUrl:</span>
                    <span class="test-row__value">{{ providerForm.get('redirects.successUrl')?.value || 'Not set'
                      }}</span>
                  </div>
                </div>
                <div class="test-card__cta bg-neutral-100 border border-neutral-300 p-6 text-center rounded-md">
                  <div class="text-neutral-600 mb-4">
                    Test connection to verify credentials
                  </div>

                  <button type="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all 
                 disabled:pointer-events-none disabled:opacity-50 outline-none 
                 focus-visible:ring-2 focus-visible:ring-ring/50 
                 border border-neutral-400 bg-background text-neutral-900 
                 hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                    Run Connection Test
                  </button>
                </div>
              </div>
              }
              }
            </form>
            <div class="wizard-card__footer">
              @if(currentStep()!=1) {<button type="button" class="btn-ghost" [disabled]="currentStep() === 1"
                (click)="prevStep()">
                Back
              </button>}
              <button type="button" class="btn-primary" (click)="currentStep() < 3 ? nextStep() : onFinish()">
                {{ currentStep() < 3 ? 'Continue' : 'Save Provider' }} </button>
            </div>

          </div>
        </div>
      </div>
      }

    </main>
  </div>
</div>}

@if (confirmDeleteOpen) {
  <div class="modal-backdrop">
    <div class="modal">
      <h3 class="modal__title">Delete provider</h3>
      <p class="modal__text">
        Are you sure you want to remove this provider? This action cannot be undone.
      </p>

      <div class="modal__actions">
        <button
          type="button"
          class="btn-ghost"
          (click)="closeDeleteDialog()"
        >
          Cancel
        </button>

        <button
          type="button"
          class="btn-danger"
          (click)="confirmDelete()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
}

