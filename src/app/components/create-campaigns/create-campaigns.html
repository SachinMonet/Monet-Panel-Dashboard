@if (isLoading()) {
<div class="loader-wrapper">
    <div class="loader-container">
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
    </div>
    <p class="loader-text">Loading...</p>
</div>
} @else {

<div class="campaign-container">
    <div class="campaign-shell">

        <header class="campaign-header">
            <div class="campaign-header__content">
                <button class="campaign-header__back" type="button" routerLink="/dashboard" title="Go back">
                    <lucide-icon name="arrow-left" class="icon"></lucide-icon>
                </button>
                <div class="campaign-header__logo"><span>PM</span></div>
                <h1 class="campaign-header__title">Create Campaign</h1>
            </div>
        </header>

        <div class="campaign-steps">
            <div class="campaign-steps__content">
                @for (step of steps; track step.stepNumber; let last = $last) {
                <button class="campaign-step" type="button" disabled
                    [class.campaign-step--active]="isStepActive(step.stepNumber)"
                    [class.campaign-step--completed]="isStepCompleted(step.stepNumber)">
                    <div class="campaign-step__circle" [class.campaign-step__circle--active]="
                  isStepActive(step.stepNumber) ||
                  isStepCompleted(step.stepNumber)
                ">
                        @if (isStepCompleted(step.stepNumber)) {
                        <span>{{ step.stepNumber }}</span>
                        } @else {
                        <span>{{ step.stepNumber }}</span>
                        }
                    </div>
                    <p class="campaign-step__label">{{ step.stepName }}</p>
                </button>

                @if (!last) {
                <div class="campaign-steps__divider"></div>
                }
                }
            </div>
        </div>

        <main class="campaign-main">
            <div class="campaign-form">
                <h2 class="campaign-form__title">{{ currentStepData.title }}</h2>

                @switch (currentStepData.stepNumber) {

                @case (2) {
                <form [formGroup]="form">
                    <div class="panel-configuration">

                        <div class="panel-header">
                            <h2 class="panel-title"></h2>
                            <button class="btn-add-panel" type="button" (click)="addPanel()">
                                <lucide-icon name="plus" class="icon-small"></lucide-icon> Add Panel
                            </button>
                        </div>

                        <div class="panel-section allocation-mode">
                            <div class="allocation-mode-content">
                                <div>
                                    <div class="allocation-label">Allocation Mode</div>
                                    <div class="allocation-description">Manually set target completes for each panel
                                    </div>
                                </div>
                                <div class="allocation-buttons">
                                    <button class="btn-allocation" type="button"
                                        [class.active]="allocationMode === 'manual'"
                                        (click)="setAllocationMode('manual')">
                                        Manual
                                    </button>

                                    <button class="btn-allocation" type="button"
                                        [class.active]="allocationMode === 'auto'" (click)="setAllocationMode('auto')">
                                        Auto-Allocate
                                    </button>
                                </div>

                            </div>
                        </div>

                        @if (allocationMode === 'manual') {
                        <div class="panel-section allocated-completes"
                            [class.allocated-completes--over]="allocationDiff > 0">
                            <div class="allocated-content">
                                <div class="allocated-left">
                                    <lucide-icon name="circle-alert" class="warning-icon"></lucide-icon>
                                    <div>
                                        <div class="allocated-label">Allocated Completes</div>
                                        <div class="allocated-value">
                                            {{ allocatedTotal }} / {{ targetTotal }}
                                        </div>
                                    </div>
                                </div>

                                <div class="allocated-over">
                                    @if (allocationDiff > 0) {
                                    Over by {{ allocationDiff }}
                                    } @else if (allocationDiff < 0) { Remaining {{ -allocationDiff }} } @else {
                                        Perfectly allocated } </div>
                                </div>
                            </div>
                            }


                            <div class="panel-table-container">
                                <table class="panel-table">
                                    <thead>
                                        <tr>
                                            <th>Panel Provider</th>
                                            <th>Target Completes</th>
                                            <th>Achieved</th>
                                            <th>CPI ($)</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>

                                    <tbody [formArrayName]="this.currentStepData.stepName">

                                        @if (panels.length === 0) {
                                        <tr class="empty-row">
                                            <td colspan="6" style="text-align:center; padding: 2rem; color: #666;">
                                                No panels added yet. Click "Add Panel" to start.
                                            </td>
                                        </tr>
                                        }

                                        @for (panel of panels.controls; track $index) {
                                        <tr class="panel-row" [formGroupName]="$index">
                                            <td>{{ panel?.get('providerName')?.value }}</td>

                                            <td>
                                                <input type="text" class="input-number" placeholder="0"
                                                    formControlName="target" />
                                            </td>

                                            <td>0</td>

                                            <td>
                                                <input type="number" step="0.01" class="input-number" placeholder="0.00"
                                                    formControlName="cpi" />
                                            </td>

                                            <td>Active</td>

                                            <td>
                                                <div class="actions">
                                                    <button class="action-btn" type="button" title="Edit">
                                                        <lucide-icon name="square-pen" class="icon-tiny"></lucide-icon>
                                                    </button>
                                                    <button class="action-btn" type="button" title="Remove"
                                                        (click)="removePanel($index)">
                                                        <lucide-icon name="trash-2" class="icon-tiny"></lucide-icon>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                </form>
                }

                @case (3) {
                <div class="review-card">
                    <h3 class="review-card__title">Campaign Details</h3>
                    <div class="review-grid">
                        <div class="review-row">
                            <span class="review-label">Name:</span>
                            <span class="review-value">
                                {{ reviewData()?.campaign_details?.name || 'Not set' }}
                            </span>
                        </div>

                        <div class="review-row">
                            <span class="review-label">Country:</span>
                            <span class="review-value">
                                {{ reviewData()?.campaign_details?.country?.name || 'Not set' }}
                            </span>
                        </div>

                        <div class="review-row">
                            <span class="review-label">LOI:</span>
                            <span class="review-value">
                                {{ reviewData()?.campaign_details?.loi ? reviewData().campaign_details.loi + ' min' :
                                'Not set' }}
                            </span>
                        </div>

                        <div class="review-row">
                            <span class="review-label">IR:</span>
                            <span class="review-value">
                                {{ reviewData()?.campaign_details?.ir ? reviewData().campaign_details.ir + '%' : 'Not
                                set' }}
                            </span>
                        </div>

                        <div class="review-row">
                            <span class="review-label">Target:</span>
                            <span class="review-value">
                                {{ reviewData()?.campaign_details?.total_target || 'Not set' }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="review-card">
                    <h3 class="review-card__title">Panel Allocation</h3>
                    <div class="review-panel-list">

                        @if (!reviewData()?.panel_allocation?.length) {
                        <div class="review-panel-row">No panels allocated</div>
                        }

                        @for (panel of reviewData()?.panel_allocation; track $index) {
                        <div class="review-panel-row">
                            <span class="review-panel-name">
                                {{ panel.panel_provider_name}}
                            </span>
                            <span class="review-panel-meta">
                                {{ panel.target_completes }} completes @ ${{ panel.cpi }} CPI
                            </span>
                        </div>
                        }
                    </div>

                    <div class="review-total">
                        <span>Total Allocated</span>
                        <span>{{ reviewData()?.summary?.total_completes }} completes</span>
                    </div>
                </div>

                }

                @default {
                <form [formGroup]="form">
                    <div class="campaign-form__group" [formGroupName]="currentStepData.stepName">
                        @for (control of currentStepData.controls; track control.name) {
                        <div class="form-field" [class.form-field--full]="control.colSpan === 2"
                            [class.form-field--half]="control.colSpan === 1">
                            @switch (control.type) {

                            @case ('input') {
                            <label class="form-label" [for]="control.name">
                                {{ control.label }}
                                @if (control.required) { <span class="form-label__required">*</span> }
                            </label>
                            <input class="form-input" [id]="control.name" [type]="control.inputType || 'text'"
                                [placeholder]="control.placeholder || ''" [formControlName]="control.name" />
                            }

                            @case ('dropdown') {
                            <label class="form-label" [for]="control.name">
                                {{ control.label }}
                                @if (control.required) { <span class="form-label__required">*</span> }
                            </label>
                            <select class="form-select" [id]="control.name" [formControlName]="control.name">
                                <option selected disabled value="">
                                    {{ control.placeholder || 'Select option' }}
                                </option>

                                @if (control.name === 'language') {
                                @for (lang of languages; track lang.id) {
                                <option [value]="lang.id">{{ lang.name }}</option>
                                }
                                } @else if (control.name === 'country') {
                                @for (country of countries; track country.id) {
                                <option [value]="country.id">{{ country.name }}</option>
                                }
                                } @else if (control.options && control.options.length > 0) {
                                @for (option of control.options; track $index) {
                                <option [value]="option">{{ option }}</option>
                                }
                                }
                            </select>
                            }

                            @case ('textarea') {
                            <label class="form-label" [for]="control.name">
                                {{ control.label }}
                                @if (control.required) { <span class="form-label__required">*</span> }
                            </label>
                            <textarea class="form-textarea" [id]="control.name" rows="4"
                                [placeholder]="control.placeholder || ''" [formControlName]="control.name"></textarea>
                            }
                            }

                            @if (form.get(currentStepData.stepName).get(control.name).touched &&
                            form.get(currentStepData.stepName).get(control.name).invalid) {
                            @let ctrl = form.get(control.name!)!;
                            @if (ctrl.hasError('required')) {
                            <span class="form-error">{{ control.label }} is required</span>
                            } @else if (ctrl.hasError('min')) {
                            <span class="form-error">{{ control.label }} must be at least {{ ctrl.getError('min').min
                                }}</span>
                            } @else if (ctrl.hasError('max')) {
                            <span class="form-error">{{ control.label }} must be at most {{ ctrl.getError('max').max
                                }}</span>
                            } @else if (ctrl.hasError('minlength')) {
                            <span class="form-error">{{ control.label }} must be at least {{
                                ctrl.getError('minlength').requiredLength }}</span>
                            }
                            }

                        </div>
                        }
                    </div>
                </form>
                }
                }

                @if (currentStepData.stepNumber !== 4) {
                <div class="campaign-form__actions">
                    @if (currentStep > 1) {
                    <button class="btn btn--secondary" (click)="previousStep()">
                        Previous
                    </button>
                    }
                    @if (currentStep < totalSteps) { <button class="btn btn--primary"
                        (click)="nextStep(currentStepData.stepNumber)"
                        [disabled]="form.get(currentStepData.stepName).invalid">
                        Continue
                        </button>
                        } @else {
                        <button class="btn btn--primary" (click)="submitForm()">
                            Launch Campaign
                        </button>


                        }
                </div>
                }

            </div>
        </main>
    </div>
</div>
}

@if(isAddPanelOpen){
<app-add-panel (close)="closeAddPanel()" (savePanel)="handlePanelSaved($event)"></app-add-panel>
}