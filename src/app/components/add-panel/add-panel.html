<div class="dialog-backdrop">
  @if (isLoading()) {
  <div class="loader-wrapper">
    <div class="loader-container">
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
    </div>
    <p class="loader-text">Loading...</p>
  </div>
  } @else {
  <div class="dialog-content" role="dialog" aria-modal="true">
    <button type="button" class="btn btn-ghost " (click)="onCancel()">x</button>

    <header class="dialog-header">
      <h2 class="dialog-title">Add Panel Provider</h2>
      <p class="dialog-description">
        Configure panel provider settings, qualifications, and quotas.
      </p>
    </header>

    <div class="dialog-steps">
      @for (s of [1, 2, 3]; track s; let last = $last) {
      <div class="step-group">
        <div class="step-icon" [class.step-icon--active]="currentStep() >= s"
          [class.step-icon--current]="currentStep() === s">
          {{ s }}
        </div>
        <div class="step-label">
          @switch (s) {
          @case (1) { Choose Panel }
          @case (2) { Qualifications }
          @case (3) { Quotas }
          }
        </div>
        @if (!last) { <div class="step-line" [class.step-line--active]="currentStep() > s"></div> }
      </div>
      }
    </div>

    <div class="dialog-body">
      @switch (currentStep()) {

      @case (1) {
      <section class="step-content" [formGroup]="form">
        <div class="form-grid">

          <div class="form-field full-width">
            <label for="panel-provider" class="form-label">Choose Panel</label>
            <select id="panel-provider" class="form-input" formControlName="panelProvider">
              @for (d of panelProviders(); track d.id) {
              <option [value]="d.id">{{ d.name }}</option>
              }
            </select>
          </div>

          <div class="form-field">
            <label class="form-label">Max Complete <span class="required">*</span></label>
            <input type="number" class="form-input" placeholder="e.g. 500" formControlName="maxComplete" />
          </div>

          <div class="form-field">
            <label class="form-label">CPI ($) <span class="required">*</span></label>
            <div class="input-prefix-wrapper">
              <span class="prefix">$</span>
              <input type="number" step="0.01" class="form-input with-prefix" placeholder="0.00"
                formControlName="cpi" />
            </div>
          </div>

          <div class="form-field full-width">
            <label class="form-label">Entry URL <span class="required">*</span></label>
            <input type="text" class="form-input" placeholder="https://..." formControlName="entryUrl" />
          </div>

        </div>
      </section>
      }

      @case (2) {
      <section class="step-content flex-column">

        <div class="search-container">
          <i data-lucide="search" class="search-icon"></i>
          <input type="text" class="search-input" placeholder="Search qualifications..."
            [formControl]="searchControl" />
        </div>

        <div class="questions-scroll-area">
          <div class="questions-list">
            @for (q of filteredQuestions(); track q.id) {
            <div class="question-card" [class.question-card--active]="openQuestionId() === q.id">

              <div class="question-main-row">
                <div class="question-info">
                  <span class="question-title">{{ q.label }}</span>
                  <span class="question-badge">{{ q.type }}</span>
                </div>

                <div class="row-actions">
                  <button type="button" class="btn btn-sm btn-outline" (click)="toggleAccordion(q.id)">
                    {{ openQuestionId() === q.id ? 'Close' : 'Select Options' }}
                  </button>

                  <button type="button" (click)="toggleAddQuestion(q.id, $event)"
                    [title]="isQuestionAdded(q.id) ? 'Remove' : 'Add'" class="btn-toggle-add"
                    [class.is-added]="isQuestionAdded(q.id)">

                    @if (isQuestionAdded(q.id)) {
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="lucide lucide-check w-4 h-4">
                      <path d="M20 6 9 17l-5-5" />
                    </svg>
                    } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="lucide lucide-plus w-4 h-4">
                      <path d="M5 12h14"></path>
                      <path d="M12 5v14"></path>
                    </svg>
                    }
                  </button>
                </div>
              </div>

              @if (openQuestionId() === q.id) {
              <div class="options-panel">
                <div class="options-grid">
                  @for (opt of questionOptions()[q.id]; track opt.id) {
                  <label class="checkbox-card" [class.checked]="isOptionSelected(q.id, opt.id)">
                    <input type="checkbox" class="hidden-checkbox" [checked]="isOptionSelected(q.id, opt.id)"
                      (change)="toggleOption(q.id, opt.id)" />
                    <div class="custom-checkbox">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 6 9 17l-5-5" />
                      </svg>
                    </div>
                    <span class="option-text">{{ opt.label }}</span>
                  </label>
                  }
                </div>
              </div>
              }
            </div>
            }
          </div>
        </div>

        @if (selectedSummary().length > 0) {
        <div class="selection-summary-bar">
          <div class="summary-header">
            <span class="summary-label">Selected Qualifications</span>
            <span class="summary-count">{{ selectedSummary().length }}</span>
          </div>
          <div class="summary-tags">
            @for (item of selectedSummary(); track item.id) {
            <div class="summary-tag">
              <span class="tag-title">{{ item.title }}:</span>
              <span class="tag-values">{{ item.options.join(', ') }}</span>
              <button type="button" class="tag-remove" (click)="toggleAddQuestion(item.id)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 6 6 18" />
                  <path d="m6 6 12 12" />
                </svg>
              </button>
            </div>
            }
          </div>
        </div>
        }
      </section>
      }

      @case (3) {
      <section class="step-content" [formGroup]="form">

        <!-- Quota Configuration Section -->
        <div class="space-y-4">
          <!-- Header with Add Quota Button -->
          <div class="flex justify-between items-center">
            <label class="flex items-center gap-2 text-sm leading-none font-medium select-none text-neutral-900">
              Quota Configuration
            </label>
            <button type="button" (click)="addQuota()"
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] border bg-background text-foreground hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3 border-neutral-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="w-4 h-4 mr-1">
                <path d="M5 12h14"></path>
                <path d="M12 5v14"></path>
              </svg>
              Add Quota
            </button>
          </div>

          <!-- Quotas List -->
          <div formArrayName="quotas" class="space-y-3">
            @for (quota of quotas.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="border border-neutral-300 p-4 rounded">

              <!-- Quota Header -->
              <div class="flex justify-between items-start mb-3">
                <div class="text-sm font-semibold text-neutral-900">
                  Quota {{ i + 1 }}
                </div>
                <button type="button" (click)="removeQuota(i)" class="p-1 hover:bg-neutral-200 rounded">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-4 h-4 text-neutral-700">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                  </svg>
                </button>
              </div>

              <!-- Quota Name and Target -->
              <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                  <label class="items-center gap-2 font-medium select-none text-neutral-900 text-xs mb-1 block">
                    Quota Name
                  </label>
                  <input type="text" formControlName="name" placeholder="e.g., Male 25-34"
                    class="flex w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 text-sm focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] border-neutral-300 h-9"
                    [class.border-red-500]="quota.get('name')?.invalid && quota.get('name')?.touched">
                </div>
                <div>
                  <label class="items-center gap-2 font-medium select-none text-neutral-900 text-xs mb-1 block">
                    Target
                  </label>
                  <input type="number" formControlName="target" placeholder="100"
                    class="flex w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 text-sm focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] border-neutral-300 h-9"
                    [class.border-red-500]="quota.get('target')?.invalid && quota.get('target')?.touched">
                </div>
              </div>

              <!-- Conditions Section -->
              <div class="border-t border-neutral-300 pt-3">
                <div class="flex justify-between items-center mb-2">
                  <label class="flex items-center gap-2 font-medium select-none text-neutral-900 text-xs">
                    Conditions
                  </label>
                  <button type="button" (click)="addCondition(i)"
                    class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] border bg-background text-foreground hover:bg-accent hover:text-accent-foreground rounded-md gap-1.5 px-3 border-neutral-400 h-7 text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="w-3 h-3 mr-1">
                      <path d="M5 12h14"></path>
                      <path d="M12 5v14"></path>
                    </svg>
                    Add Condition
                  </button>
                </div>

                <!-- Conditions List -->
                <div formArrayName="conditions" class="space-y-2">
                  @for (condition of getConditions(i).controls; track $index; let j = $index) {
                  <div [formGroupName]="j" class="flex gap-2 items-start">

                    <div class="flex-1 grid grid-cols-2 gap-2">
                      <!-- Question Select -->
                      <select formControlName="question"
                        class="flex w-full items-center justify-between gap-2 rounded-md border bg-input-background px-3 py-2 whitespace-nowrap transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 border-neutral-300 h-8 text-xs"
                        [class.border-red-500]="condition.get('question')?.invalid && condition.get('question')?.touched">
                        <option value="" disabled selected>Select question</option>
                        @for (q of getAvailableQuestionsForQuota(); track q.value) {
                        <option [value]="q.value">{{ q.label }}</option>
                        }
                      </select>

                      <!-- Answer Input -->
                      <input type="text" formControlName="answer" placeholder="e.g., Male"
                        class="flex w-full min-w-0 rounded-md border px-3 py-1 bg-input-background transition-[color,box-shadow] outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 text-sm focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] border-neutral-300 h-8 text-xs"
                        [class.border-red-500]="condition.get('answer')?.invalid && condition.get('answer')?.touched">
                    </div>

                    <!-- Remove Condition Button -->
                    <button type="button" (click)="removeCondition(i, j)"
                      class="p-1 hover:bg-neutral-200 rounded shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="w-4 h-4 text-neutral-700">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                      </svg>
                    </button>
                  </div>
                  }
                </div>
              </div>
            </div>
            }

            <!-- Empty State Message -->
            @if (quotas.length === 0) {
            <div class="text-center py-8 text-neutral-500">
              <p>No quotas configured yet. Click "Add Quota" to get started.</p>
            </div>
            }
          </div>
        </div>
      </section>
      }
      }
    </div>

    <footer class="dialog-actions">
      @if (currentStep() > 1){<button type="button" class=" btn-back" (click)="onBack()"
        [disabled]="currentStep() === 1">
        Back
      </button>}

      <div class="action-right">
        @if (currentStep() == 2) { <button type="button" class="btn btn-primary"
          [disabled]="currentStep() === 1 && form.invalid" (click)="onFinish()">
          Skip & Finish
        </button>
        }

        @if (currentStep() < 3) { <button type="button" class="btn btn-primary"
          [disabled]="currentStep() === 1 && form.invalid" (click)="onNext()">
          Next Step
          </button>
          } @else {
          <button type="button" class="btn btn-primary" (click)="onFinish()">
            Finish
          </button>
          }
      </div>
    </footer>

    <button type="button" class="dialog-close-icon" (click)="onCancel()" aria-label="Close">
      <i data-lucide="x"></i>
    </button>

  </div>}
</div>